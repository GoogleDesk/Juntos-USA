<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recursos Legales Cercanos — ApoyoYA</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: {} },
        corePlugins: { preflight: true }
      };
    </script>

    <!-- React 18 UMD + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      html, body, #root { height: 100%; }
      body { background:#fff; color:#0f172a; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, createContext, useContext, useRef } = React;

      // --- i18n ---
      const SUPPORTED_LANGS = ["es","en"];
      const COPY = {
        es: {
          brand: "Apoyo a Inmigrantes",
          sections: { finderTitle: "Recursos Legales Cercanos", finderSub: "Busque por código postal, categoría y pro bono" },
          labels: {
            zipcode: "Código postal",
            category: "Categoría",
            proBonoOnly: "Solo pro bono",
            call: "Llamar",
            website: "Sitio web",
            noResults: "No se encontraron resultados con estos filtros.",
            mapNote: "Mapa provisto por OpenStreetMap"
          }
        },
        en: {
          brand: "Immigrant Support",
          sections: { finderTitle: "Legal Resources Nearby", finderSub: "Filter by ZIP, category and pro bono" },
          labels: {
            zipcode: "ZIP code",
            category: "Category",
            proBonoOnly: "Pro bono only",
            call: "Call",
            website: "Website",
            noResults: "No results for these filters.",
            mapNote: "Map provided by OpenStreetMap"
          }
        }
      };
      const LangCtx = createContext({ lang: "es", setLang: () => {} });
      const useI18n = () => useContext(LangCtx);
      const safeCopy = (lang) => COPY[SUPPORTED_LANGS.includes(lang) ? lang : "es"];

      // --- categories ---
      const CATEGORIES = ["asilo","defensa","trabajo","vivienda","naturalizacion","familia","detencion"];
      const CATEGORY_LABELS = {
        es: {
          asilo: "Asilo", defensa: "Defensa", trabajo: "Trabajo", vivienda: "Vivienda",
          naturalizacion: "Naturalización", familia: "Familia", detencion: "Detención"
        },
        en: {
          asilo: "Asylum", defensa: "Defense", trabajo: "Work", vivienda: "Housing",
          naturalizacion: "Naturalization", familia: "Family", detencion: "Detention"
        }
      };

      // --- UI helpers ---
      function Badge({ children }) {
        return <span className="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-xs text-slate-700">{children}</span>;
      }
      function CTAButton({ href, children, variant="primary" }) {
        const base = "inline-flex items-center justify-center rounded-lg px-3 py-2 text-sm font-semibold shadow-sm border";
        const style = variant === "secondary"
          ? " bg-white text-slate-800 hover:bg-slate-50 border-slate-300"
          : " bg-emerald-600 text-white hover:bg-emerald-700 border-emerald-700";
        return <a href={href} className={base + style} target={href?.startsWith("http") ? "_blank": undefined} rel="noreferrer">{children}</a>;
      }
      function Card({ children }) {
        return <div className="rounded-2xl border border-slate-200 bg-white">{children}</div>;
      }
      function Pill({ children, active, onClick }) {
        const base = "inline-flex items-center rounded-full px-3 py-1 text-sm border";
        const cls = active
          ? " bg-emerald-600 text-white border-emerald-700"
          : " bg-white text-slate-800 hover:bg-slate-50 border-slate-300";
        return <button onClick={onClick} className={base + " " + cls}>{children}</button>;
      }

      // --- sanitizer for /data/resources.json ---
      async function loadResources() {
        const res = await fetch("./data/resources.json", { cache: "no-store" });
        const text = await res.text();
        const cleaned = text
          .replace(/mix\s*=\s*true/gi, "true")
          .replace(/lowCost\s*=\s*false/gi, "false");
        try {
          return JSON.parse(cleaned);
        } catch (e) {
          console.error("JSON parse error", e);
          return [];
        }
      }

      // --- Map helpers ---
      const mapRef = { current: null };
      const markersRef = { current: [] };
      function initMap() {
        if (mapRef.current || typeof L === "undefined") return;
        mapRef.current = L.map("finder-map", { zoomControl: true, attributionControl: true })
          .setView([39.5, -98.35], 4);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(mapRef.current);
      }
      function updateMap(results) {
        initMap();
        if (!mapRef.current) return;
        // clear markers
        markersRef.current.forEach(m => mapRef.current.removeLayer(m));
        markersRef.current = [];
        const bounds = [];
        (results || []).forEach(r => {
          if (typeof r.lat === "number" && typeof r.lng === "number") {
            const m = L.marker([r.lat, r.lng]).addTo(mapRef.current);
            m.bindPopup(\`<strong>\${r.name || ""}</strong><br/>\${r.address || ""}\`);
            markersRef.current.push(m);
            bounds.push([r.lat, r.lng]);
          }
        });
        if (bounds.length) mapRef.current.fitBounds(bounds, { padding:[30,30] });
      }

      // --- Main Finder Page ---
      function FinderPage() {
        const { lang } = useI18n();
        const t = safeCopy(lang);

        const [all, setAll] = useState([]);
        const [zip, setZip] = useState("");
        const [cat, setCat] = useState(null);
        const [pb, setPb] = useState(false);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        useEffect(() => {
          let alive = true;
          (async () => {
            try {
              setLoading(true);
              const data = await loadResources();
              if (alive) setAll(Array.isArray(data) ? data : []);
            } catch (e) {
              if (alive) setError(e?.message || "Load error");
            } finally {
              if (alive) setLoading(false);
            }
          })();
          return () => { alive = false; };
        }, []);

        const results = useMemo(() => {
          return all.filter(r => {
            const zipOk = zip ? String(r.zip || "").startsWith(zip) : true;
            const catOk = cat ? Array.isArray(r.categories) && r.categories.includes(cat) : true;
            const pbOk = pb ? !!r.pro_bono : true;
            return zipOk && catOk && pbOk;
          });
        }, [all, zip, cat, pb]);

        useEffect(() => { updateMap(results); }, [results]);

        return (
          <main className="min-h-screen">
            <header className="border-b border-slate-200 bg-white sticky top-0 z-40 shadow-md">
              <div className="max-w-6xl mx-auto px-4 h-14 flex items-center gap-6">
                <a href="/" className="flex items-center gap-2">
                  <img src="/logo.png" alt="ApoyoYA logo" className="h-8 w-8" />
                  <span className="font-semibold text-slate-900">{t.brand}</span>
                </a>
              </div>
            </header>

            <div className="max-w-6xl mx-auto px-4 py-8">
              <h1 className="text-2xl font-semibold text-slate-900">{t.sections.finderTitle}</h1>
              <p className="text-slate-600">{t.sections.finderSub}</p>

              <div className="mt-4 rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
                <div className="flex flex-col sm:flex-row gap-3 sm:items-end">
                  <div className="flex-1">
                    <label className="text-sm text-slate-700">{t.labels.zipcode}</label>
                    <input value={zip} onChange={(e)=>setZip(e.target.value)} inputMode="numeric" placeholder="30303"
                      className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400" />
                  </div>
                  <div className="flex-1">
                    <label className="text-sm text-slate-700">{t.labels.category}</label>
                    <div className="mt-1 flex flex-wrap gap-2">
                      {CATEGORIES.map((id) => (
                        <Pill key={id} active={cat===id} onClick={()=>setCat(cat===id?null:id)}>
                          {CATEGORY_LABELS[(SUPPORTED_LANGS.includes(lang)?lang:'es')][id]}
                        </Pill>
                      ))}
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <input id="pb" type="checkbox" checked={pb} onChange={(e)=>setPb(e.target.checked)} className="h-4 w-4 rounded border-slate-300" />
                    <label htmlFor="pb" className="text-sm text-slate-700">{t.labels.proBonoOnly}</label>
                  </div>
                </div>

                <div className="mt-5 grid gap-4 lg:grid-cols-3">
                  <div className="lg:col-span-2 space-y-3">
                    {loading ? (
                      <Card><div className="p-4 text-sm text-slate-600">Loading…</div></Card>
                    ) : error ? (
                      <Card><div className="p-4 text-sm text-red-700">Error: {error}</div></Card>
                    ) : results.length === 0 ? (
                      <Card><div className="p-4 text-sm text-slate-600">{t.labels.noResults}</div></Card>
                    ) : (
                      results.map((r) => (
                        <Card key={r.id}>
                          <div className="p-4 sm:p-5">
                            <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                              <div>
                                <h4 className="font-semibold text-slate-900">{r.name}</h4>
                                <p className="text-sm text-slate-600">{r.address}</p>
                                <div className="mt-2 flex flex-wrap gap-2">
                                  {(r.categories || []).map((c) => (
                                    <Badge key={c}>{CATEGORY_LABELS[(SUPPORTED_LANGS.includes(lang)?lang:'es')][c] || c}</Badge>
                                  ))}
                                  {r.pro_bono ? <Badge>Pro bono</Badge> : null}
                                  <Badge>{(r.languages || []).join('/') || 'Es/En'}</Badge>
                                </div>
                              </div>
                              <div className="flex gap-2">
                                {r.phone && <CTAButton href={`tel:${r.phone}`}>{t.labels.call}</CTAButton>}
                                {r.website && <CTAButton href={r.website} variant="secondary">{t.labels.website}</CTAButton>}
                              </div>
                            </div>
                          </div>
                        </Card>
                      ))
                    )}
                  </div>

                  <div className="rounded-xl border border-slate-200 bg-slate-50 p-3">
                    <div id="finder-map" className="aspect-[4/3] w-full rounded-lg"></div>
                    <p className="mt-2 text-xs text-slate-600">{t.labels.mapNote}</p>
                  </div>
                </div>
              </div>
            </div>
          </main>
        );
      }

      function App() {
        const [lang, setLang] = useState("es");
        return (
          <LangCtx.Provider value={{ lang, setLang }}>
            <FinderPage />
          </LangCtx.Provider>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
