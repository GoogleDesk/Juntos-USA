<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Legal Resources Nearby — ApoyoYA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { theme: { extend: {} }, corePlugins: { preflight: true } };
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style> html,body,#root{height:100%} body{background:#fff;color:#0f172a} </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;

      const COPY = {
        es: {
          backHome: "Inicio",
          title: "Recursos Legales Cercanos",
          subtitle: "Busca por estado/ciudad/código postal, categoría, idioma y si es pro bono.",
          zipcode: "Código postal",
          city: "Ciudad",
          state: "Estado",
          category: "Categoría",
          language: "Idioma",
          proBonoOnly: "Solo pro bono",
          useMyLocation: "Usar mi ubicación (beta)",
          clear: "Limpiar",
          noResults: "No hay resultados. Ajusta los filtros.",
          distance: "Distancia",
          miles: "mi",
        },
        en: {
          backHome: "Home",
          title: "Legal Resources Nearby",
          subtitle: "Search by state/city/ZIP, category, language, and pro bono availability.",
          zipcode: "ZIP code",
          city: "City",
          state: "State",
          category: "Category",
          language: "Language",
          proBonoOnly: "Pro bono only",
          useMyLocation: "Use my location (beta)",
          clear: "Clear",
          noResults: "No results. Adjust your filters.",
          distance: "Distance",
          miles: "mi",
        }
      };

      const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DC","DE","FL","GA","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WA","WI","WV","WY"];
      const CATEGORIES = [
        { id: "asilo", en: "Asylum", es: "Asilo" },
        { id: "defensa", en: "Removal defense", es: "Defensa contra deportación" },
        { id: "trabajo", en: "Work", es: "Trabajo" },
        { id: "vivienda", en: "Housing", es: "Vivienda" },
        { id: "salud", en: "Health", es: "Salud" },
      ];

      const toRad = d => (d * Math.PI) / 180;
      function haversine(lat1, lon1, lat2, lon2) {
        if ([lat1, lon1, lat2, lon2].some(v => v == null || Number.isNaN(v))) return null;
        const R = 3958.8;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      function App() {
        const [lang, setLang] = useState("es");
        const t = COPY[lang];

        const [zip, setZip] = useState("");
        const [city, setCity] = useState("");
        const [state, setState] = useState("");
        const [cat, setCat] = useState("");
        const [langFilter, setLangFilter] = useState("");
        const [proBonoOnly, setProBonoOnly] = useState(false);
        const [items, setItems] = useState([]);
        const [geo, setGeo] = useState(null);

        useEffect(() => {
          async function load() {
            try {
              const r = await fetch("/data/resources.json");
              const json = await r.json();
              setItems(json);
            } catch (e) {
              console.error("Failed to load resources.json", e);
              setItems([]);
            }
          }
          load();
        }, []);

        const results = useMemo(() => {
          const qCity = city.trim().toLowerCase();
          const qLang = langFilter.trim().toLowerCase();
          let list = items.filter(r =>
            (zip ? (r.zip || "").startsWith(zip) : true) &&
            (state ? (r.state || "") === state : true) &&
            (qCity ? (r.city || "").toLowerCase().includes(qCity) : true) &&
            (cat ? (r.categories || []).includes(cat) : true) &&
            (proBonoOnly ? !!r.pro_bono : true) &&
            (qLang ? (r.languages || []).some(l => String(l).toLowerCase().includes(qLang)) : true)
          );
          if (geo && geo.lat && geo.lon) {
            list = list.map(r => ({
              ...r,
              _dist: (r.lat != null && r.lon != null) ? haversine(geo.lat, geo.lon, r.lat, r.lon) : null
            })).sort((a,b) => {
              if (a._dist != null && b._dist != null) return a._dist - b._dist;
              if (a._dist != null) return -1;
              if (b._dist != null) return 1;
              return (a.state || "").localeCompare(b.state || "") || (a.city || "").localeCompare(b.city || "") || (a.name || "").localeCompare(b.name || "");
            });
          } else {
            list = list.sort((a,b) => (a.state || "").localeCompare(b.state || "") || (a.city || "").localeCompare(b.city || "") || (a.name || "").localeCompare(b.name || ""));
          }
          return list;
        }, [items, zip, city, state, cat, langFilter, proBonoOnly, geo]);

        function getLocation() {
          if (!navigator.geolocation) { alert("Geolocation not supported in this browser."); return; }
          navigator.geolocation.getCurrentPosition(
            (pos) => setGeo({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
            (err) => { console.warn(err); alert("Could not get location."); }
          );
        }

        return (
          <main className="min-h-screen bg-white text-slate-900">
            <header className="border-b border-slate-200 bg-white/80 sticky top-0 z-40">
              <div className="mx-auto max-w-6xl px-4 h-14 flex items-center gap-3">
                <a href="/index.html" className="text-sm text-slate-700 hover:text-slate-900">{t.backHome}</a>
                <div className="ml-auto flex items-center gap-2">
                  <button onClick={() => setLang(lang === "es" ? "en" : "es")} className="inline-flex items-center gap-2 rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-800 hover:bg-slate-50">
                    {lang === "es" ? "Switch to English" : "Cambiar a español"}
                  </button>
                </div>
              </div>
            </header>

            <section className="py-10 sm:py-12">
              <div className="mx-auto max-w-6xl px-4">
                <h1 className="text-2xl sm:text-3xl font-semibold">{t.title}</h1>
                <p className="mt-1 text-slate-600">{t.subtitle}</p>

                <div className="mt-5 rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
                  <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <div>
                      <label className="text-sm text-slate-700">{t.zipcode}</label>
                      <input value={zip} onChange={e=>setZip(e.target.value)} inputMode="numeric" placeholder="30303" className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                    </div>
                    <div>
                      <label className="text-sm text-slate-700">{t.city}</label>
                      <input value={city} onChange={e=>setCity(e.target.value)} placeholder="Atlanta" className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                    </div>
                    <div>
                      <label className="text-sm text-slate-700">{t.state}</label>
                      <select value={state} onChange={e=>setState(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
                        <option value="">{lang === "es" ? "Todos" : "All"}</option>
                        {STATES.map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="text-sm text-slate-700">{t.category}</label>
                      <select value={cat} onChange={e=>setCat(e.target.value)} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
                        <option value="">{lang === "es" ? "Todas" : "All"}</option>
                        {CATEGORIES.map(c => <option key={c.id} value={c.id}>{lang === "es" ? c.es : c.en}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="text-sm text-slate-700">{t.language}</label>
                      <input value={langFilter} onChange={e=>setLangFilter(e.target.value)} placeholder="es, en" className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                    </div>
                    <div className="flex items-end gap-2">
                      <label className="flex items-center gap-2 text-sm text-slate-700">
                        <input type="checkbox" checked={proBonoOnly} onChange={e=>setProBonoOnly(e.target.checked)} className="h-4 w-4 rounded border-slate-300" />
                        {t.proBonoOnly}
                      </label>
                    </div>
                    <div className="flex items-end">
                      <button onClick={getLocation} className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">{t.useMyLocation}</button>
                    </div>
                    <div className="flex items-end">
                      <button onClick={() => { setZip(""); setCity(""); setState(""); setCat(""); setLangFilter(""); setProBonoOnly(false); }} className="w-full rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:bg-slate-800">{t.clear}</button>
                    </div>
                  </div>
                </div>

                <div className="mt-5 grid gap-4 lg:grid-cols-3">
                  <div className="lg:col-span-2 space-y-3">
                    {results.length === 0 ? (
                      <div className="rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600">{t.noResults}</div>
                    ) : results.map(r => (
                      <div key={r.id} className="rounded-2xl border border-slate-200 bg-white p-4 sm:p-5">
                        <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                          <div>
                            <h3 className="font-semibold text-slate-900">{r.name}</h3>
                            <p className="text-sm text-slate-600">{r.address}{r.city?', '+r.city:''}{r.state?', '+r.state:''}</p>
                            <div className="mt-2 flex flex-wrap gap-2 text-xs text-slate-700">
                              {r.categories?.map(c => <span key={c} className="inline-flex items-center rounded-full border border-slate-300 px-2 py-0.5">{c}</span>)}
                              {r.pro_bono ? <span className="inline-flex items-center rounded-full border border-slate-300 px-2 py-0.5">Pro bono</span> : null}
                              {r.languages?.length ? <span className="inline-flex items-center rounded-full border border-slate-300 px-2 py-0.5">{(r.languages||[]).join(", ")}</span> : null}
                              {r._dist != null ? <span className="inline-flex items-center rounded-full border border-slate-300 px-2 py-0.5">{t.distance}: {r._dist.toFixed(1)} {t.miles}</span> : null}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            {r.phone ? <a className="inline-flex items-center justify-center rounded-xl bg-emerald-700 px-4 py-2 text-white font-medium hover:bg-emerald-800" href={`tel:${r.phone}`}>Call</a> : null}
                            {r.website ? <a className="inline-flex items-center justify-center rounded-xl border border-slate-300 px-4 py-2 text-slate-800 font-medium hover:bg-slate-50" href={r.website} target="_blank">Website</a> : null}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="rounded-xl border border-slate-200 bg-slate-50 p-3">
                    <div className="aspect-[4/3] w-full rounded-lg bg-[linear-gradient(45deg,#e2e8f0,#cbd5e1)] flex items-center justify-center text-slate-600 text-sm">
                      Map placeholder (static page)
                    </div>
                    <p className="mt-2 text-xs text-slate-600">We can embed a real map later (Mapbox/Leaflet).</p>
                  </div>
                </div>
              </div>
            </section>
          </main>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
